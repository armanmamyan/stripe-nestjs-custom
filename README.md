# NestJS API with Stripe Integration

This project is a NestJS-based REST API that provides user authentication, Stripe payment handling, and subscription management. It leverages TypeORM for database operations, JWT for token-based authentication, and integrates Stripe to handle subscriptions, invoices, and payment processing.

## Features

- **User Authentication**: Sign-up, login, JWT-based authentication, and token validation.
- **Stripe Payment Integration**: Manages subscriptions, invoices, and payments for users via Stripe.
- **Password Reset Functionality**: Securely resets user passwords.
- **Webhook Handling**: Receives Stripe webhooks to handle subscription events (e.g., payment failures, subscription cancellations).
- **API Documentation**: Uses Swagger for interactive API documentation.

## Table of Contents

- [Installation](#installation)
- [Environment Variables](#environment-variables)
- [Running the Application](#running-the-application)
- [Usage](#usage)
- [API Endpoints](#api-endpoints)
- [Stripe Integration](#stripe-integration)
- [License](#license)

## Installation

1. Clone the repository:
   ```bash
   git clone https://github.com/your-username/your-repo.git
   cd your-repo
  ```
2. Install Dependencies
```bash
  pnpm i
```
## Environment Variables

Create a `.env` file in the project root and add the following environment variables:

STAGE=development  
DB_USERNAME=your_db_username  
DB_PASSWORD=your_db_password  
DB_HOST=your_db_host  
DB_PORT=5432  
DB_NAME=your_db_name  
STRIPE_SECRET=your_stripe_secret  
STRIPE_WEBHOOK_SECRET=your_stripe_webhook_secret  
PRIVATE_KEY=your_jwt_private_key  
PORT=3000  

> **Note:** Make sure to set the appropriate `STRIPE_SECRET` and `STRIPE_WEBHOOK_SECRET` values from your Stripe Dashboard.


## Running the Application

1. Start the NestJS Application:
   pnpm start:local

2. Access Swagger API Documentation:
   Visit http://localhost:3000/api for an interactive API documentation generated by Swagger.


## Usage

This API provides endpoints for managing user accounts, processing payments, and managing subscriptions.

### Authentication Flow

1. Signup - Users create an account.
2. Login - Users log in and receive a JWT token for authenticated access.
3. Token Validation - Validates the userâ€™s JWT token for session management.
4. Password Reset - Users can reset their password securely with a token-based approach.

### Stripe Subscription and Payment Flow

1. Customer Creation - Each user is registered as a customer in Stripe.
2. Subscription Management - Attach payment methods, create subscriptions, and handle payments through Stripe.
3. Webhook Integration - Receives and handles Stripe webhooks to manage events like subscription renewals, cancellations, and payment successes/failures.

## API Endpoints

Below is an overview of the key endpoints. For detailed information, refer to the Swagger documentation.

### Auth Routes

- POST /auth/sign-in - User login with JWT token generation.
- POST /auth/forget-password - Sends password reset token to user's email.

### User Routes

- POST /user/signup - Creates a new user.
- POST /user/update-user - Updates user details.
- GET /user - Retrieves user data.
- GET /user/validate-token - Validates JWT token expiration.

### Stripe Routes

- GET /stripe/stripe/validate-stripe - Validates if a user has a Stripe account, creates one if not.
- POST /user/stripe/create-subscription - Creates a Stripe subscription for a user.
- POST /user/stripe/process-payment - Processes a one-time payment.

### Webhook

- POST /stripe/webhook - Handles Stripe webhook events such as payment success, subscription creation, and cancellations.

## Stripe Integration

This app uses the `@golevelup/nestjs-stripe` module for Stripe API interaction. The `StripeService` class in `stripe/stripe.service.ts` manages customer creation, payment method attachment, subscription management, and webhook processing.

Stripe webhook integration is configured to verify incoming Stripe event signatures. Ensure the `STRIPE_WEBHOOK_SECRET` matches the webhook secret from the Stripe Dashboard.





```bash
# Read Data from a Table
SELECT * FROM "table_name";
```

## To clear all tables' data, follow these steps using the Heroku CLI and SQL commands.
```bash
# Read Data from a Table
TRUNCATE TABLE "table1", "table2", "table3" CASCADE;
```
# OR

```bash
# Clear All Tables Automatically
DO $$ DECLARE
  r RECORD;
BEGIN
  FOR r IN (SELECT tablename FROM pg_tables WHERE schemaname = 'public') LOOP
    EXECUTE 'TRUNCATE TABLE ' || quote_ident(r.tablename) || ' CASCADE;';
  END LOOP;
END $$;
```


## Generate migration file based on recent local changes

1. Go to src/config/typeorm.config-migrations.ts
2. Change  url, host, port, username, password, database to Heroku DB addresses
3. run 
```bash
pnmp run migration:generate
```
4. run 
```bash
pnpm run migration:run
```
5. Push migration file to git


## Run ngrok to test 3rd party webhooks or https connections
1. Install ngrok
https://ngrok.com/download

2. Run the following command
```bash
pnmp run ngrok
```


## License

This project is licensed under the MIT License.